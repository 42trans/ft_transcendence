<!-- user.html -->

{% load static %}
<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>User Page</title>
</head>
<body>
<h1>User Page (private)</h1>

<div id="user-info"></div>
<div id="friends-container"></div>
<div id="requests-container"></div>

<!-- todo: jsã¸ç§»å‹• -->
<script>
    document.addEventListener("DOMContentLoaded", function() {
        fetch("/accounts/api/user/profile/")
            .then(response => response.json())
            .then(data => {
                const userInfo = document.getElementById("user-info");
                userInfo.innerHTML = `
            <li>Email: ${data.email}</li>
            <li>Nickname: ${data.nickname}</li>
            <li>avater: [avater here]</li>
            ${data.has_usable_password ? '<li>Password: ******</li>' : ''}
            <li><a href="/accounts/edit/">Edit Profile</a></li>
            <br>
            ${data.enable_2fa ?
                    `<li>2FA: âœ…Enabled</li><li><a href="/accounts/verify/disable_2fa/">Disable 2FA</a></li>` :
                    `<li>2FA: Disabled</li><li><a href="/accounts/verify/enable_2fa/">Enable 2FA</a></li>`}
            <br>
            <button onclick="handleLogout()">Logout</button>
            <br>
            `;
            })
            .catch(error => console.error("Error:", error));


        // ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¹ãƒˆã®å–å¾—
        fetch("/accounts/api/friend/list/")
            .then(response => response.json())
            .then(data => {
                const friendsContainer = document.getElementById("friends-container");
                const friendsList = document.createElement('div');
                friendsList.innerHTML = "<h3>Friends</h3>";
                const friendsUl = document.createElement('ul');
                data.friends.forEach(friend => {
                    const li = document.createElement('li');
                    li.innerHTML = `${friend.nickname} <a href="#" onclick="deleteFriend(${friend.id}); return false;">Delete</a>`;
                    friendsUl.appendChild(li);
                });
                friendsList.appendChild(friendsUl);
                friendsContainer.appendChild(friendsList);
            })
            .catch(error => console.error("Error:", error));


        // ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ãƒªã‚¹ãƒˆã®ä¸€è¦§
        fetch("/accounts/api/friend/requests/")
            .then(response => response.json())
            .then(data => {
                const requestsContainer = document.getElementById("requests-container");

                // é€ä¿¡ã—ãŸãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                const sentRequestsDiv = document.createElement('div');
                sentRequestsDiv.innerHTML = "<h3>Sent Friend Requests</h3>";
                const sentRequestsUl = document.createElement('ul');
                data.sent_requests.forEach(req => {
                    const li = document.createElement('li');
                    li.innerHTML = `Request sent to ${req.receiver__nickname} <a href="#" onclick="cancelFriendRequest(${req.receiver_id}); return false;">Cancel</a>`;
                    sentRequestsUl.appendChild(li);
                });
                sentRequestsDiv.appendChild(sentRequestsUl);
                requestsContainer.appendChild(sentRequestsDiv);

                // å—ä¿¡ã—ãŸãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                const receivedRequestsDiv = document.createElement('div');
                receivedRequestsDiv.innerHTML = "<h3>Received Friend Requests</h3>";
                const receivedRequestsUl = document.createElement('ul');
                data.received_requests.forEach(req => {
                    const li = document.createElement('li');
                    li.innerHTML = `Request from ${req.sender__nickname} <a href="#" onclick="acceptFriendRequest(${req.sender_id}); return false;">Accept</a> <a href="#" onclick="rejectFriendRequest(${req.sender_id}); return false;">Reject</a>`;
                    receivedRequestsUl.appendChild(li);
                });
                receivedRequestsDiv.appendChild(receivedRequestsUl);
                requestsContainer.appendChild(receivedRequestsDiv);
            })
            .catch(error => console.error("Error:", error));
    });
</script>

<script src="{% static 'accounts/js/logout.js' %}"></script>
<script src="{% static 'accounts/js/friend.js' %}"></script>

<hr>
<br>
<p><a href="{% url 'chat:dm_sessions' %}">DM</a></p>
<a href="/pong/">ğŸ“ Pong Index Page</a>
</body>
</html>
