<!-- user.html -->

{% load static %}
<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>User Page</title>

    <style>
        .avatar {
            width: 50px;    /* å¹…ã‚’30pxã«è¨­å®š */
            height: 50px;   /* é«˜ã•ã‚’30pxã«è¨­å®š */
            border-radius: 50%;  /* è§’ã‚’å††å½¢ã«ã™ã‚‹ */
            object-fit: cover;   /* ç”»åƒã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ãªãŒã‚‰ã€è¨­å®šã•ã‚ŒãŸé ˜åŸŸã«åã¾ã‚‹ã‚ˆã†ã«ã™ã‚‹ */
            margin-right: 10px;  /* ç”»åƒã¨ãƒ†ã‚­ã‚¹ãƒˆã®é–“ã®ä½™ç™½ */
        }

        .status.online {
            color: green;
        }

        .status.offline {
            color: red;
        }
    </style>
</head>
<body>
<h1>User Page (private)</h1>

<div id="user-info"></div>
<hr>
<div id="friends-container"></div>
<hr>
<div id="requests-container"></div>

<!-- todo: jsã¸ç§»å‹• -->
<script>
    document.addEventListener("DOMContentLoaded", function() {
        fetch("/accounts/api/user/profile/")
            .then(response => response.json())
            .then(data => {
                const userInfo = document.getElementById("user-info");
                userInfo.innerHTML = `
                <li>Email: ${data.email}</li>
                <li>Nickname: ${data.nickname}</li>
                ${data.has_usable_password ? '<li>Password: ******</li>' : ''}
                <li><a href="/accounts/edit/">Edit Profile</a></li>
                <br>
                <li>Avatar: <img src="${data.avatar_url}" alt="User Avatar" class="avatar">
                <a href="/accounts/change-avatar/">Edit Avatar</a></li>
                <br>
                ${data.enable_2fa ?
                        `<li>2FA: âœ…Enabled</li><li><a href="/accounts/verify/disable_2fa/">Disable 2FA</a></li>` :
                        `<li>2FA: Disabled</li><li><a href="/accounts/verify/enable_2fa/">Enable 2FA</a></li>`}
                <br>
                <button onclick="handleLogout()">Logout</button>
                <br>
                `;

                setUpOnlineStatusWebSocket(data.id);  // OnlieStatusWebSocketã«æ¥ç¶š
            })
            .catch(error => console.error("Error:", error));


        fetch('/accounts/api/friend/list/')
            .then(response => response.json())
            .then(data => {
                createFriendsList(data);
            })
            .catch(error => console.error('Error loading friends:', error));


        // ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ãƒªã‚¹ãƒˆã®ä¸€è¦§
        fetch("/accounts/api/friend/requests/")
            .then(response => response.json())
            .then(data => {
                const requestsContainer = document.getElementById("requests-container");

                // é€ä¿¡ã—ãŸãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                const sentRequestsDiv = document.createElement('div');
                sentRequestsDiv.innerHTML = "<h3>Sent Friend Requests</h3>";
                const sentRequestsUl = document.createElement('ul');
                data.sent_requests.forEach(req => {
                    const li = document.createElement('li');
                    li.innerHTML = `Request sent to <a href="/accounts/info/${req.nickname}/">${req.nickname}</a> <a href="#" onclick="cancelFriendRequest(${req.friend_id}); return false;">Cancel</a>`;
                    sentRequestsUl.appendChild(li);
                });
                sentRequestsDiv.appendChild(sentRequestsUl);
                requestsContainer.appendChild(sentRequestsDiv);

                // å—ä¿¡ã—ãŸãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                const receivedRequestsDiv = document.createElement('div');
                receivedRequestsDiv.innerHTML = "<h3>Received Friend Requests</h3>";
                const receivedRequestsUl = document.createElement('ul');
                data.received_requests.forEach(req => {
                    const li = document.createElement('li');
                    li.innerHTML = `Request from  <a href="/accounts/info/${req.nickname}/">${req.nickname}</a> <a href="#" onclick="acceptFriendRequest(${req.friend_id}); return false;">Accept</a> <a href="#" onclick="rejectFriendRequest(${req.friend_id}); return false;">Reject</a>`;
                    receivedRequestsUl.appendChild(li);
                });
                receivedRequestsDiv.appendChild(receivedRequestsUl);
                requestsContainer.appendChild(receivedRequestsDiv);
            })
            .catch(error => console.error("Error:", error));
    });
</script>

<script src="{% static 'accounts/js/logout.js' %}"></script>
<script src="{% static 'accounts/js/friend.js' %}"></script>
<script src="{% static 'accounts/js/online-status.js' %}"></script>

<hr>
<br>
<p><a href="{% url 'chat:dm_sessions' %}">DM</a></p>
<a href="/pong/">ğŸ“ Pong Index Page</a>
</body>
</html>
