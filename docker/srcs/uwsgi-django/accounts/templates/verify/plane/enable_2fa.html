{% comment %} <!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>Enable 2FA</title>
</head>
<body>
<h2>Enable Two-Factor Authentication (2FA)</h2>

<div id="qrCodeContainer" style="margin-bottom: 20px;"></div>
<div id="error-message" style="color: red;"></div>

<form id="enableForm">
  <label for="token">Verification Code:</label>
  <input type="text" id="token" name="token" required>
  <button type="button" onclick="verifyToken()">Enable 2FA</button>
</form>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    fetch('/accounts/api/enable_2fa/', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      }
    })
            .then(response => response.json())
            .then(data => {
              if (data.error) {
                document.getElementById('error-message').textContent = "Error retrieving 2FA setup: " + data.error;
              } else if (data.redirect) {
                console.log(data.message);
                window.location.href = data.redirect;
              }
              else {
                const qrCodeHtml = `
                <p>Scan this QR Code with your authenticator app:</p>
                <img src="data:image/png;base64,${data.qr_code_data}" alt="2FA QR Code"><br>
                <p>Or enter this setup key: ${data.setup_key}</p>
            `;
                document.getElementById('qrCodeContainer').innerHTML = qrCodeHtml;
              }
            })
            .catch(error => {
              document.getElementById('error-message').textContent = "Network error or server is down.";
              console.error("Fetch error:", error);
            });
  });

  function verifyToken() {
    const token = document.getElementById('token').value;
    fetch('/accounts/api/enable_2fa/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ token: token })
    })
            .then(response => response.json())
            .then(data => {
              if (data.error) {
                document.getElementById('error-message').textContent = "Verification failed: " + data.error;
              } else if (data.redirect) {
                console.log(data.message);
                window.location.href = data.redirect;
              } else if (data.success) {
                console.log(data.message);
                alert(data.message);
                window.location.href = data.redirect;
              }
            })
            .catch(error => {
              document.getElementById('error-message').textContent = "Network error or server is down.";
              console.error("Fetch error:", error);
            });
  }
</script>

<hr>
<a href="/accounts/user/">Return to user page</a>
<br>
<a href="/pong/">🏓 Return to pong</a>
</body>
</html>

<!--{% load static %}-->
<!--<!doctype html>-->
<!--<html lang="ja">-->
<!--<head>-->
<!--  <meta charset="utf-8">-->
<!--  <title>2FA</title>-->
<!--</head>-->
<!--<body>-->
<!--<h2>Enable Two-Factor Authentication (2FA)</h2>-->

<!--{% if qr_code_data %}-->
<!--  <p>以下のQRコード or Setup KeyをAuthenticatorに登録してください</p>-->
<!--  <img src="data:image/png;base64,{{ qr_code_data }}" alt="2FA QR Code">-->
<!--  <br>-->

<!--  <p>setup key: {{ setup_key }}</p>-->
<!--  <p>Setup KeyはQRコードのバックアップにもなります。セキュリティに注意して大切に保管してください。</p>-->
<!--  <br>-->
<!--  <p>アプリが生成したトークンを以下のフォームで認証してください</p>-->
<!--{% endif %}-->

<!--<form method="post">-->
<!--  {% csrf_token %}-->
<!--  <label for="token">Verification Code:</label>-->
<!--  <input type="text" id="token" name="token" required>-->

<!--  &lt;!&ndash; エラーメッセージの表示 &ndash;&gt;-->
<!--  {% if form.non_field_errors %}-->
<!--  <div class="error" style="color: red;">-->
<!--    {% for error in form.non_field_errors %}-->
<!--    {{ error }}-->
<!--    {% endfor %}-->
<!--  </div>-->
<!--  {% endif %}-->

<!--  <button type="submit" class="btn btn-primary">Verify and Enable 2FA</button>-->
<!--</form>-->

<!--<hr>-->
<!--<a href="{% url 'accounts:user'%}">return to user page</a>-->
<!--<hr>-->
<!--<a href="/pong">🏓 return to pong</a>-->
<!--</body>-->
<!--</html>--> {% endcomment %}
